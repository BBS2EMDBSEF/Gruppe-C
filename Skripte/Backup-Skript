# Backup-Skript erstellen
log "Erstelle Backup-Skript..."
cat > /usr/local/bin/create-system-backup <<EOF
#!/bin/bash

# Backup-Verzeichnis erstellen
BACKUP_DIR="/home/pi/backups/\$(date +%Y%m%d_%H%M%S)"
mkdir -p \$BACKUP_DIR

# Datenbank-Dump erstellen
echo "Erstelle MariaDB Backup..."
mysqldump --all-databases -u root -p\$(cat /home/pi/mariadb_root_password.txt) > \$BACKUP_DIR/all_databases.sql

# Apache Konfiguration sichern
echo "Sichere Apache Konfiguration..."
cp -r /etc/apache2 \$BACKUP_DIR/apache2_conf
cp -r /var/www \$BACKUP_DIR/www_backup

# PHP Konfiguration sichern
echo "Sichere PHP Konfiguration..."
cp -r /etc/php \$BACKUP_DIR/php_conf

# MariaDB Konfiguration sichern
echo "Sichere MariaDB Konfiguration..."
cp -r /etc/mysql \$BACKUP_DIR/mysql_conf

# Systemkonfiguration sichern
echo "Sichere Systemkonfiguration..."
cp /etc/hosts \$BACKUP_DIR/
cp /etc/hostname \$BACKUP_DIR/
cp /etc/fstab \$BACKUP_DIR/

# Backup komprimieren
echo "Komprimiere Backup..."
cd \$(dirname \$BACKUP_DIR)
tar -czf \$BACKUP_DIR.tar.gz \$(basename \$BACKUP_DIR)
rm -rf \$BACKUP_DIR

echo "Backup wurde erstellt: \$BACKUP_DIR.tar.gz"

# Alte Backups aufräumen (behält die letzten 5)
cd /home/pi/backups
ls -t *.tar.gz | tail -n +6 | xargs -r rm

echo "Backup abgeschlossen!"
EOF
