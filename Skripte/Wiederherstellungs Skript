# Wiederherstellungs-Skript erstellen
log "Erstelle Wiederherstellungs-Skript..."
cat > /usr/local/bin/restore-system-backup <<EOF
#!/bin/bash

if [ "\$#" -ne 1 ]; then
    echo "Verwendung: \$0 /pfad/zum/backup.tar.gz"
    exit 1
fi

BACKUP_FILE=\$1
RESTORE_DIR="/tmp/restore_\$(date +%s)"

if [ ! -f "\$BACKUP_FILE" ]; then
    echo "Backup-Datei nicht gefunden!"
    exit 1
fi

echo "Stelle Backup wieder her..."

# Backup entpacken
mkdir -p \$RESTORE_DIR
tar -xzf \$BACKUP_FILE -C \$RESTORE_DIR

BACKUP_CONTENT=\$RESTORE_DIR/\$(ls \$RESTORE_DIR)

# Dienste stoppen
systemctl stop apache2 mariadb

# Konfigurationen wiederherstellen
echo "Stelle Konfigurationen wieder her..."
cp -r \$BACKUP_CONTENT/apache2_conf/* /etc/apache2/
cp -r \$BACKUP_CONTENT/www_backup/* /var/www/
cp -r \$BACKUP_CONTENT/php_conf/* /etc/php/
cp -r \$BACKUP_CONTENT/mysql_conf/* /etc/mysql/

# Systemkonfiguration wiederherstellen
cp \$BACKUP_CONTENT/hosts /etc/hosts
cp \$BACKUP_CONTENT/hostname /etc/hostname
cp \$BACKUP_CONTENT/fstab /etc/fstab

# Datenbanken wiederherstellen
echo "Stelle Datenbanken wieder her..."
mysql -u root -p\$(cat /home/pi/mariadb_root_password.txt) < \$BACKUP_CONTENT/all_databases.sql

# Berechtigungen korrigieren
chown -R www-data:www-data /var/www

# Dienste neustarten
systemctl start apache2 mariadb

# AufrÃ¤umen
rm -rf \$RESTORE_DIR

echo "Wiederherstellung abgeschlossen!"
echo "Bitte System neu starten mit: sudo reboot"
EOF
